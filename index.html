<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡æª¢æ‰“å¡ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; text-align: center; background-color: #f8f9fa; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        h2 { margin-top: 0; color: #333; }
        .location-tag { background: #e9ecef; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-bottom: 15px; font-weight: bold; color: #495057;}
        .status { margin: 20px 0; padding: 15px; background: #f1f3f5; border-radius: 8px; text-align: left; font-size: 0.95em; line-height: 1.6; }
        button { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; background-color: #0d6efd; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #adb5bd; }
        .success { color: #198754; font-weight: bold; text-align: center; display: block; margin-top: 10px;}
        .fail { color: #dc3545; font-weight: bold; text-align: center; display: block; margin-top: 10px;}
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ“ å·¡æª¢æ‰“å¡</h2>
        
        <div id="spotName" class="location-tag">æœªæŒ‡å®šé»ä½</div>

        <div id="result" class="status">è«‹æƒæç¾å ´ QR Code é–‹å•Ÿæ­¤é é¢</div>
        
        <button id="checkBtn" onclick="checkLocation()">ğŸ“ ç¢ºèªæ‰“å¡</button>
    </div>

    <script>
        // ==========================================
        // 1. è¨­å®šç›®æ¨™ç¶“ç·¯åº¦ (å¤§æ¨“çš„ä¸­å¿ƒé»)
        // ==========================================
        const TARGET_LAT = 24.73529; 
        const TARGET_LNG = 121.75624;
        const ALLOWED_DISTANCE = 80; // ç¯„åœè¨­å¤§ä¸€é»ï¼Œæ¶µè“‹æ•´æ£Ÿæ¨“
        // ==========================================

        // 2. å–å¾—ç¶²å€åƒæ•¸ (åˆ¤æ–·æ˜¯å“ªä¸€å±¤æ¨“)
        const urlParams = new URLSearchParams(window.location.search);
        const spotID = urlParams.get('id'); // è®€å–ç¶²å€ä¸­çš„ ?id=...

        // å®šç¾©é»ä½åç¨±å°ç…§è¡¨
        const spots = {
            "1F_LOBBY": "1F å¤§å»³é–€å£",
            "3F_OFFICE": "3F è¾¦å…¬å®¤",
            "5F_MEETING": "5F æœƒè­°å®¤",
            "B1_WAREHOUSE": "B1 å€‰åº«"
        };

        // åˆå§‹åŒ–ç•«é¢
        const spotDisplay = document.getElementById("spotName");
        const resultDiv = document.getElementById("result");
        const btn = document.getElementById("checkBtn");

        if (spotID && spots[spotID]) {
            spotDisplay.innerText = "ç›®æ¨™ï¼š" + spots[spotID];
            resultDiv.innerText = "é»ä½è­˜åˆ¥æˆåŠŸï¼Œè«‹é»æ“ŠæŒ‰éˆ•é©—è­‰ä½ç½®ã€‚";
        } else {
            spotDisplay.innerText = "âš ï¸ ç„¡æ•ˆçš„é»ä½";
            spotDisplay.style.background = "#f8d7da";
            spotDisplay.style.color = "#721c24";
            resultDiv.innerHTML = "è«‹å‹™å¿…æƒæç‰†ä¸Šçš„ QR Code é€²å…¥ï¼Œ<br>ä¸å¯ç›´æ¥é–‹å•Ÿç¶²é ã€‚";
            btn.disabled = true; // é–ä½æŒ‰éˆ•
        }

        function checkLocation() {
            if (!navigator.geolocation) {
                resultDiv.innerHTML = "ä¸æ”¯æ´å®šä½åŠŸèƒ½";
                return;
            }

            resultDiv.innerHTML = "ğŸ“¡ å®šä½ç¢ºèªä¸­...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const currentLat = position.coords.latitude;
                    const currentLng = position.coords.longitude;
                    const distance = getDistanceFromLatLonInM(currentLat, currentLng, TARGET_LAT, TARGET_LNG);

                    let msg = `GPS è·é›¢èª¤å·®ï¼š${distance.toFixed(1)} å…¬å°º<br>`;

                    // é›™é‡é©—è­‰é‚è¼¯
                    if (distance <= ALLOWED_DISTANCE) {
                        // 1. GPS é€šé
                        msg += `<span class="success">âœ… æ‰“å¡æˆåŠŸï¼</span>`;
                        msg += `<div style="text-align:center; margin-top:5px;">å·²å®Œæˆ <b>${spots[spotID]}</b> å·¡æª¢</div>`;
                        // é€™è£¡å¯ä»¥æœªä¾†æ“´å……ï¼šæŠŠ spotID å’Œ æ™‚é–“ å‚³é€åˆ° Google Sheets
                    } else {
                        // 2. GPS å¤±æ•—
                        msg += `<span class="fail">âŒ æ‰“å¡å¤±æ•—</span>`;
                        msg += `<div style="text-align:center; font-size:0.9em;">QR Code æ­£ç¢ºï¼Œä½†æ‚¨çš„ GPS ä½ç½®ä¸åœ¨ç¯„åœå…§ã€‚<br>è«‹ç¢ºèªæ˜¯å¦åœ¨ç¾å ´ã€‚</div>`;
                    }

                    resultDiv.innerHTML = msg;
                    // å¦‚æœå¤±æ•—ï¼Œå…è¨±é‡è©¦
                    if (distance > ALLOWED_DISTANCE) btn.disabled = false; 
                },
                (error) => {
                    resultDiv.innerHTML = "<span class='fail'>ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹æª¢æŸ¥ GPS æ¬Šé™</span>";
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371000; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }
    </script>
</body>
</html>
